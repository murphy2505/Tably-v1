// Prisma schema for Tably Step 1 (clean)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  OPEN
  SENT
  IN_PREP
  READY
  COMPLETED
  CANCELLED
}

enum MenuChannel {
  POS
  WEB
  BOTH
}

model Tenant {
  id        String   @id
  name      String
  createdAt DateTime @default(now())

  revenueGroups              RevenueGroup[]
  productGroups              ProductGroup[]
  categories                 Category[]
  products                   Product[]
  variants                   ProductVariant[]
  menus                      Menu[]
  courses                    Course[]
  menuItems                  MenuItem[]
  vatRates                   VatRate[]
  orders                     Order[]
  orderLines                 OrderLine[]
  // New back-relations
  modifierGroups             ModifierGroup[]
  modifierOptions            ModifierOption[]
  productModifierGroups      ProductModifierGroup[]
  menuCards                  MenuCard[]
  menuCardSchedules          MenuCardSchedule[]
  menuCardItems              MenuCardItem[]
  menuCardItemModifierGroups MenuCardItemModifierGroup[]
  settings                   TenantSettings?
}

model RevenueGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productGroups ProductGroup[]
  categories    Category[]
  products      Product[]

  @@index([tenantId, isActive, sortOrder])
}

model VatRate {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  rate      Int
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  products      Product[]
  productGroups ProductGroup[]
  categories    Category[]

  @@index([tenantId, isActive, sortOrder])
}

model ProductGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // defaults (optional)
  revenueGroupId String?
  revenueGroup   RevenueGroup? @relation(fields: [revenueGroupId], references: [id], onDelete: SetNull)

  vatRateId String?
  vatRate   VatRate? @relation(fields: [vatRateId], references: [id], onDelete: SetNull)

  products Product[]

  @@unique([tenantId, name])
  @@index([tenantId, name])
}

model Category {
  id        String  @id @default(cuid())
  tenantId  String
  name      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  defaultRevenueGroupId String?
  defaultRevenueGroup   RevenueGroup? @relation(fields: [defaultRevenueGroupId], references: [id], onDelete: SetNull)

  defaultVatRateId String?
  defaultVatRate   VatRate? @relation(fields: [defaultVatRateId], references: [id], onDelete: SetNull)

  @@index([tenantId, sortOrder])
}

model Product {
  id             String @id @default(cuid())
  tenantId       String
  productGroupId String
  categoryId     String

  // overrides (optional)
  revenueGroupId String?
  vatRateId      String?

  name           String
  description    String?
  basePriceCents Int
  imageUrl       String?
  allergenTags   Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productGroup ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Restrict)
  category     Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  revenueGroup RevenueGroup? @relation(fields: [revenueGroupId], references: [id], onDelete: SetNull)
  vatRate      VatRate?      @relation(fields: [vatRateId], references: [id], onDelete: SetNull)

  variants              ProductVariant[]
  menuItems             MenuItem[]
  productModifierGroups ProductModifierGroup[]
  MenuCardItem          MenuCardItem[]

  @@index([tenantId, productGroupId])
  @@index([tenantId, categoryId])
  @@index([tenantId, revenueGroupId])
  @@index([tenantId, vatRateId])
}

model ProductVariant {
  id                 String  @id @default(cuid())
  tenantId           String
  productId          String
  name               String
  priceOverrideCents Int?
  sortOrder          Int     @default(0)
  isActive           Boolean @default(true)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  menuItems     MenuItem[]
  menuCardItems MenuCardItem[]

  @@index([tenantId, productId, sortOrder])
}

// New: Modifiers MVP
model ModifierGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  minSelect Int      @default(0)
  maxSelect Int      @default(1)
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant                    Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  options                   ModifierOption[]
  products                  ProductModifierGroup[]
  MenuCardItemModifierGroup MenuCardItemModifierGroup[]

  @@index([tenantId, isActive, sortOrder])
}

model ModifierOption {
  id              String  @id @default(cuid())
  tenantId        String
  groupId         String
  name            String
  priceDeltaCents Int     @default(0)
  isActive        Boolean @default(true)
  sortOrder       Int     @default(0)

  group  ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, groupId, isActive, sortOrder])
}

model ProductModifierGroup {
  id        String @id @default(cuid())
  tenantId  String
  productId String
  groupId   String
  sortOrder Int    @default(0)

  tenant  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productId, groupId])
  @@index([tenantId, productId, sortOrder])
}

model Menu {
  id         String  @id @default(cuid())
  tenantId   String
  name       String
  slug       String
  channel    String
  layoutType String
  columns    Int     @default(4)
  isActive   Boolean @default(true)
  sortOrder  Int     @default(0)

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive, channel])
}

model Course {
  id         String  @id @default(cuid())
  tenantId   String
  name       String
  shortLabel String?
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@index([tenantId, sortOrder])
}

model MenuItem {
  id                 String  @id @default(cuid())
  tenantId           String
  menuId             String
  productId          String
  variantId          String?
  courseId           String?
  sortOrder          Int     @default(0)
  priceOverrideCents Int?
  isActive           Boolean @default(true)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menu    Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  course  Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([tenantId, menuId, sortOrder])
  @@index([tenantId, productId])
  @@index([tenantId, variantId])
}

// New: Menu Cards with schedules
model MenuCard {
  id        String      @id @default(cuid())
  tenantId  String
  name      String
  channel   MenuChannel @default(BOTH)
  isActive  Boolean     @default(true)
  sortOrder Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt

  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schedules MenuCardSchedule[]
  items     MenuCardItem[]

  @@index([tenantId, isActive, sortOrder])
}

model MenuCardSchedule {
  id         String  @id @default(cuid())
  tenantId   String
  menuCardId String
  enabled    Boolean @default(true)
  dayOfWeek  Int
  startTime  String
  endTime    String

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuCard MenuCard @relation(fields: [menuCardId], references: [id], onDelete: Cascade)

  @@index([tenantId, menuCardId, enabled, dayOfWeek])
}

model MenuCardItem {
  id         String  @id @default(cuid())
  tenantId   String
  menuCardId String
  productId  String?
  variantId  String?
  sortOrder  Int     @default(0)

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuCard MenuCard        @relation(fields: [menuCardId], references: [id], onDelete: Cascade)
  product  Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Attach modifier groups to this menu card item
  modifierGroups MenuCardItemModifierGroup[]

  @@index([tenantId, menuCardId, sortOrder])
}

model MenuCardItemModifierGroup {
  id                String  @id @default(cuid())
  tenantId          String
  menuCardItemId    String
  groupId           String
  sortOrder         Int     @default(0)
  isActive          Boolean @default(true)
  minSelectOverride Int?
  maxSelectOverride Int?

  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item   MenuCardItem  @relation(fields: [menuCardItemId], references: [id], onDelete: Cascade)
  group  ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, menuCardItemId, groupId])
  @@index([tenantId, menuCardItemId, isActive, sortOrder])
}

model Order {
  id       String      @id @default(cuid())
  tenantId String
  status   OrderStatus @default(OPEN)

  sentAt      DateTime?
  inPrepAt    DateTime?
  readyAt     DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines  OrderLine[]

  @@index([tenantId, status])
}

model OrderLine {
  id         String @id @default(cuid())
  tenantId   String
  orderId    String
  title      String
  qty        Int
  priceCents Int
  modifiers  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId, orderId])
}

model TenantSettings {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  webshopEnabled  Boolean  @default(true)
  webshopTimezone String   @default("Europe/Amsterdam")
  openingHours    Json
  closures        Json
  messageClosed   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}
