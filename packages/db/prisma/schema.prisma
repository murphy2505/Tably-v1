// Prisma schema for Tably Step 1 (clean)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  OPEN
  SENT
  IN_PREP
  READY
  PAID
  COMPLETED
  CANCELLED
  PARKED
  VOIDED
}

enum OrderKind {
  QUICK
  TRACKED
}

enum MenuChannel {
  POS
  WEB
  BOTH
}

model Tenant {
  id        String   @id
  name      String
  createdAt DateTime @default(now())

  // Core business
  revenueGroups RevenueGroup[]
  vatRates      VatRate[]

  // Products & menus
  productGroups ProductGroup[]
  categories    Category[]
  products      Product[]
  variants      ProductVariant[]
  modifierGroups        ModifierGroup[]
  modifierOptions       ModifierOption[]
  productModifierGroups ProductModifierGroup[]

  menus       Menu[]
  courses     Course[]
  menuItems   MenuItem[]
  menuCards   MenuCard[]
  menuCardSchedules          MenuCardSchedule[]
  menuCardItems              MenuCardItem[]
  menuCardItemModifierGroups MenuCardItemModifierGroup[]

  // Orders & sales
  orders     Order[]
  orderLines OrderLine[]

  receiptSequences ReceiptSequence[]
  orderSequences   OrderSequence[]

  // Loyalty
  customers       Customer[]
  loyaltyAccounts LoyaltyAccount[]

  // Printing
  printers     Printer[]
  printConfigs PrintConfig[]

  // Settings
  settings TenantSettings?
}

model RevenueGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productGroups ProductGroup[]
  categories    Category[]
  products      Product[]

  @@index([tenantId, isActive, sortOrder])
}

model VatRate {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  rate      Int
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  products      Product[]
  productGroups ProductGroup[]
  categories    Category[]
  menuCardItems MenuCardItem[]

  @@index([tenantId, isActive, sortOrder])
}

model ProductGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // defaults (optional)
  revenueGroupId String?
  revenueGroup   RevenueGroup? @relation(fields: [revenueGroupId], references: [id], onDelete: SetNull)

  vatRateId String?
  vatRate   VatRate? @relation(fields: [vatRateId], references: [id], onDelete: SetNull)

  products Product[]

  @@unique([tenantId, name])
  @@index([tenantId, name])
}

model Category {
  id        String  @id @default(cuid())
  tenantId  String
  name      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  defaultRevenueGroupId String?
  defaultRevenueGroup   RevenueGroup? @relation(fields: [defaultRevenueGroupId], references: [id], onDelete: SetNull)

  defaultVatRateId String?
  defaultVatRate   VatRate? @relation(fields: [defaultVatRateId], references: [id], onDelete: SetNull)

  @@index([tenantId, sortOrder])
}

model Product {
  id             String @id @default(cuid())
  tenantId       String
  productGroupId String
  categoryId     String

  // overrides (optional)
  revenueGroupId String?
  vatRateId      String?

  name           String
  description    String?
  basePriceCents Int
  imageUrl       String?
  allergenTags   Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productGroup ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Restrict)
  category     Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  revenueGroup RevenueGroup? @relation(fields: [revenueGroupId], references: [id], onDelete: SetNull)
  vatRate      VatRate?      @relation(fields: [vatRateId], references: [id], onDelete: SetNull)

  variants              ProductVariant[]
  menuItems             MenuItem[]
  productModifierGroups ProductModifierGroup[]
  MenuCardItem          MenuCardItem[]

  @@index([tenantId, productGroupId])
  @@index([tenantId, categoryId])
  @@index([tenantId, revenueGroupId])
  @@index([tenantId, vatRateId])
}

model ProductVariant {
  id                 String  @id @default(cuid())
  tenantId           String
  productId          String
  name               String
  priceOverrideCents Int?
  sortOrder          Int     @default(0)
  isActive           Boolean @default(true)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  menuItems     MenuItem[]
  menuCardItems MenuCardItem[]

  @@index([tenantId, productId, sortOrder])
}

// New: Modifiers MVP
model ModifierGroup {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  minSelect Int      @default(0)
  maxSelect Int      @default(1)
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant                    Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  options                   ModifierOption[]
  products                  ProductModifierGroup[]
  MenuCardItemModifierGroup MenuCardItemModifierGroup[]

  @@index([tenantId, isActive, sortOrder])
}

model ModifierOption {
  id              String  @id @default(cuid())
  tenantId        String
  groupId         String
  name            String
  priceDeltaCents Int     @default(0)
  isActive        Boolean @default(true)
  sortOrder       Int     @default(0)

  group  ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, groupId, isActive, sortOrder])
}

model ProductModifierGroup {
  id        String @id @default(cuid())
  tenantId  String
  productId String
  groupId   String
  sortOrder Int    @default(0)

  tenant  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productId, groupId])
  @@index([tenantId, productId, sortOrder])
}

model Menu {
  id         String  @id @default(cuid())
  tenantId   String
  name       String
  slug       String
  channel    String
  layoutType String
  columns    Int     @default(4)
  isActive   Boolean @default(true)
  sortOrder  Int     @default(0)

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive, channel])
}

model Course {
  id         String  @id @default(cuid())
  tenantId   String
  name       String
  shortLabel String?
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@index([tenantId, sortOrder])
}

model MenuItem {
  id                 String  @id @default(cuid())
  tenantId           String
  menuId             String
  productId          String
  variantId          String?
  courseId           String?
  sortOrder          Int     @default(0)
  priceOverrideCents Int?
  isActive           Boolean @default(true)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menu    Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  course  Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([tenantId, menuId, sortOrder])
  @@index([tenantId, productId])
  @@index([tenantId, variantId])
}

// New: Menu Cards with schedules
model MenuCard {
  id        String      @id @default(cuid())
  tenantId  String
  name      String
  channel   MenuChannel @default(BOTH)
  isActive  Boolean     @default(true)
  sortOrder Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt

  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schedules MenuCardSchedule[]
  items     MenuCardItem[]

  @@index([tenantId, isActive, sortOrder])
}

model MenuCardSchedule {
  id         String  @id @default(cuid())
  tenantId   String
  menuCardId String
  enabled    Boolean @default(true)
  dayOfWeek  Int
  startTime  String
  endTime    String

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuCard MenuCard @relation(fields: [menuCardId], references: [id], onDelete: Cascade)

  @@index([tenantId, menuCardId, enabled, dayOfWeek])
}

model MenuCardItem {
  id         String  @id @default(cuid())
  tenantId   String
  menuCardId String
  productId  String?
  variantId  String?
  sortOrder  Int     @default(0)
  vatRateId  String?

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuCard MenuCard        @relation(fields: [menuCardId], references: [id], onDelete: Cascade)
  product  Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  vatRate  VatRate?        @relation(fields: [vatRateId], references: [id], onDelete: SetNull)

  // Attach modifier groups to this menu card item
  modifierGroups MenuCardItemModifierGroup[]

  @@index([tenantId, menuCardId, sortOrder])
}

model MenuCardItemModifierGroup {
  id                String  @id @default(cuid())
  tenantId          String
  menuCardItemId    String
  groupId           String
  sortOrder         Int     @default(0)
  isActive          Boolean @default(true)
  minSelectOverride Int?
  maxSelectOverride Int?

  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item   MenuCardItem  @relation(fields: [menuCardItemId], references: [id], onDelete: Cascade)
  group  ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, menuCardItemId, groupId])
  @@index([tenantId, menuCardItemId, isActive, sortOrder])
}

model Order {
  id       String      @id @default(cuid())
  tenantId String
  kind     OrderKind   @default(QUICK)
  status   OrderStatus @default(OPEN)

  // Lifecycle timestamps
  sentAt      DateTime?
  inPrepAt    DateTime?
  readyAt     DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  // Payment (MVP)
  paidAt            DateTime?
  paymentMethod     String?
  paymentRef        String?
  cashReceivedCents Int?

  // Cancellation / voiding
  voidReason   String?
  cancelReason String?

  // Receipt numbering (Scanfie-style)
  receiptNo       Int?
  receiptLabel    String?
  receiptIssuedAt DateTime?

  // Draft numbering (issued on creation)
  draftNo       Int?
  draftLabel    String?
  draftIssuedAt DateTime?

  // Customer / Loyalty
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Totals (computed backend-side, cents)
  subtotalExclVatCents Int  @default(0)
  totalInclVatCents    Int  @default(0)
  vatBreakdown         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines  OrderLine[]

  // Indexes
  @@index([tenantId, status])
  @@index([tenantId, customerId])
  @@index([updatedAt])
}

// =========================
// Loyalty — Customers and Accounts
// =========================

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  name      String?
  phoneE164 String?  // E.164 with leading +, optional
  email     String?
  isActive  Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loyalty LoyaltyAccount?
  orders  Order[]

  // Constraints / indexes
  @@unique([tenantId, phoneE164])
  @@index([tenantId, createdAt])
  @@index([tenantId, name])
}
 b
enum LoyaltyStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model LoyaltyAccount {
  id        String        @id @default(cuid())
  tenantId  String
  customerId String       @unique
  points    Int           @default(0)
  status    LoyaltyStatus @default(ACTIVE)
  tier      String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId, points])
}

model ReceiptSequence {
  id        String   @id @default(cuid())
  tenantId  String
  // YYYYMMDD code for daily sequence reset
  dateCode  String
  // Next sequence to issue for this day (starts at 2 so issuedNo = nextSeq - 1)
  nextSeq   Int      @default(2)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dateCode])
}

model OrderSequence {
  id        String   @id @default(cuid())
  tenantId  String
  // YYYYMMDD code for daily sequence reset
  dateCode  String
  // Next sequence to issue for this day (starts at 2 so issuedNo = nextSeq - 1)
  nextSeq   Int      @default(2)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dateCode])
}

model OrderLine {
  id         String @id @default(cuid())
  tenantId   String
  orderId    String
  title      String
  qty        Int
  priceCents Int
  modifiers  Json?
  // Snapshot VAT rate in basis points (e.g., 900, 2100) for this line
  vatRateBps Int    @default(2100)
  vatSource  String @default("PRODUCT")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId, orderId])
}

model TenantSettings {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  webshopEnabled  Boolean  @default(true)
  webshopTimezone String   @default("Europe/Amsterdam")
  openingHours    Json
  closures        Json
  messageClosed   String?
  // Receipt number prefix (e.g., "C"), optional
  receiptPrefix   String?
  // POS: auto-print receipt after payment
  autoPrintReceiptAfterPayment Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// =========================
// Printing settings (tenant-scoped)
// =========================

enum PrinterDriver {
  ESC_POS_TCP
  STAR_ESC_POS_TCP
  EPOS_HTTP
  STARPRNT
}

model Printer {
  id         String        @id @default(cuid())
  tenantId   String
  name       String
  driver     PrinterDriver
  host       String
  port       Int           @default(9100)
  httpUrl    String?
  paperWidth Int           @default(80) // 80 or 58
  escposAsciiMode Boolean  @default(true)
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // ✅ REQUIRED opposite relation
  routes PrintRoute[]

  @@index([tenantId, isActive])
}

// Logical print targets
enum PrintKind {
  RECEIPT
  QR_CARD
  KITCHEN
  BAR
}

model PrintRoute {
  id        String    @id @default(cuid())
  tenantId  String
  kind      PrintKind
  printerId String
  isDefault Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  printer   Printer   @relation(fields: [printerId], references: [id], onDelete: Cascade)

  @@unique([tenantId, kind])
  @@index([tenantId])
}

enum PrintTemplate {
  CUSTOMER_RECEIPT
  KITCHEN_TICKET
  QR_CARD
}

enum PrintPlan {
  NEVER
  ON_PAY
  ON_SEND_TO_KDS
  MANUAL
}

enum PrintChannel {
  POS
  WEB
  TAKEAWAY
  DELIVERY
}

model PrintConfig {
  id                            String         @id @default(cuid())
  tenantId                      String
  name                          String
  template                      PrintTemplate
  plan                          PrintPlan      @default(MANUAL)
  targetPrinters                String[] // printer IDs
  channels                      PrintChannel[]
  areas                         String[]
  prepStations                  String[]
  ignoreLinesWithoutPrepStation Boolean        @default(false)
  isActive                      Boolean        @default(true)
  createdAt                     DateTime       @default(now())
  updatedAt                     DateTime       @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
}
